# Standalone Build System

This package is built from the [revisium](https://github.com/revisium/revisium) monorepo.

## How the Bundle Works

`build.sh` uses esbuild to bundle all pure JS dependencies (NestJS, Prisma client+WASM, pg driver, ioredis, etc.) into a single file. Native modules that require platform-specific binaries stay as npm dependencies and are installed normally by npm.

## Build Prerequisites

1. Run `npm run build` (tsc) in the root revisium directory first
2. `@revisium/core`, `@revisium/endpoint`, and `@revisium/admin` must be installed in `node_modules/`
3. Admin client must be copied: `npm run copy:admin`

## Build Command

```bash
npm run standalone:build   # runs tsc + build.sh
# or
npm run build && bash standalone/build.sh
```

## What build.sh Does

1. **Clean** — removes `bin/`, `dist/`, `client/`, `prisma/`, `templates/` from `standalone/`
2. **Copy bin/** — entry point script that spawns node with `--experimental-require-module`
3. **Copy client/** — admin UI static files from `@revisium/admin`
4. **Copy runtime assets** from `@revisium/core`:
   - `prisma/migrations/` — SQL migration files (read by Prisma CLI at runtime)
   - `prisma/schema.prisma` — Prisma schema (read by Prisma CLI at runtime)
   - `prisma/seed/` — JSON data for permissions and roles (read by seed script via `__dirname`)
   - `templates/` — Handlebars email templates (read by TemplateService at runtime)
5. **esbuild main bundle** — `dist/src/standalone.js` -> `standalone/dist/standalone.js` (~14MB minified)
6. **esbuild seed bundle** — `@revisium/core/dist/prisma/seed.js` -> `standalone/prisma/seed.js` (~5MB minified)
7. **Generate package.json** — from template with versions from root and core package.json

## esbuild Externals

Modules marked `--external` are NOT bundled:

**Native modules (npm dependencies):**
- `embedded-postgres` — downloads platform-specific PostgreSQL binary
- `sharp` — native image processing (libvips)
- `bcrypt` — native password hashing
- `pg-native` — optional native PostgreSQL driver (conditionally imported)

**NestJS modules loaded via dynamic require** (npm dependencies):
- `@nestjs/microservices` — used by core's notification module (Redis transport)

**NestJS optional/lazy imports** (require'd inside try/catch, never actually used):
- `@nestjs/websockets`, `@fastify/static`, `class-transformer/storage`
- `nats`, `mqtt`, `kafkajs`, `amqplib`, `amqp-connection-manager` — microservice transports
- `@grpc/grpc-js`, `@grpc/proto-loader` — gRPC transport
- `@mikro-orm/core`, `@nestjs/sequelize`, `@nestjs/typeorm`, `@nestjs/mongoose` — optional ORMs
- `ts-morph` — Swagger plugin (dev-only)

When a new optional dependency causes esbuild to fail or crashes at runtime, add it to the `--external` list in `build.sh`.

## Path Resolution

In the bundled output, `__dirname` = `<package>/dist/`. The entry point `bin/revisium-standalone.js` sets env vars before spawning the bundle so they're available at module load time:

| Env Var | Value | Used By |
|---------|-------|---------|
| `REVISIUM_CLIENT_DIR` | `<package>/client` | `AdminModule.forRoot()` in `app.module.ts` |
| `REVISIUM_TEMPLATES_DIR` | `<package>/templates` | `TemplateService` in `@revisium/core` |

These env vars have no effect on Docker builds — the code falls back to `__dirname`-based paths when unset.

## Publish

```bash
cd standalone
npm publish --access public --tag alpha
```

## Testing Locally

```bash
cd standalone && npm pack
mkdir /tmp/standalone-test && cd /tmp/standalone-test
npm init -y
npm install /path/to/revisium-standalone-*.tgz
npx revisium-standalone
```

## Size Budget

| Component | Size |
|-----------|------|
| Main bundle (minified) | ~14MB |
| Seed bundle (minified) | ~5MB |
| Admin client | ~3.5MB |
| Prisma assets | ~0.3MB |
| **tgz (compressed)** | **~7MB** |
| Native deps (installed) | ~200MB |

## Package Structure

```
standalone/
├── bin/revisium-standalone.js      # Entry point
├── dist/standalone.js              # esbuild bundle (~14MB)
├── client/                         # Admin UI (~3.5MB)
├── prisma/
│   ├── schema.prisma
│   ├── migrations/
│   ├── seed.js                     # Bundled seed (~5MB)
│   └── seed/                       # JSON data for seed
├── templates/                      # Email templates (.hbs)
├── prisma.config.ts                # Prisma config
├── package.json.template           # Template (versioned in git)
├── package.json                    # Generated by build.sh (in .gitignore)
└── build.sh                        # Build script
```
